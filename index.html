<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic QR Linker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-container { max-width: 400px; }
        .dashboard-container { max-width: 800px; }
        /* Basic styling for message popups */
        .message-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100%); /* Start off-screen */
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .message-popup.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .message-popup.success { background-color: #28a745; } /* Green */
        .message-popup.error { background-color: #dc3545; } /* Red */

        /* Style for the QR code canvas */
        .qr-code-container {
            display: flex; /* Use flex to center content if needed */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            padding: 10px;
            min-height: 120px; /* Ensure space for QR code */
        }
        .qr-code-container canvas { 
            display: block;
            border: 1px solid #e5e7eb; /* light gray border */
            padding: 5px;
            background-color: white;
            border-radius: 4px;
        }
        .link-item {
            transition: box-shadow 0.3s ease-in-out;
        }
        .link-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="authContainer" class="w-full">
        <form id="loginForm" class="form-container mx-auto bg-white p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">Login</h2>
            <div class="mb-4">
                <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="loginEmail" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="loginPassword" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">Login</button>
            <p class="mt-6 text-center text-sm">
                Don't have an account? <a href="#" id="switchToSignup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up</a>
            </p>
        </form>

        <form id="signupForm" class="form-container mx-auto bg-white p-8 rounded-lg shadow-xl hidden">
            <h2 class="text-2xl font-bold mb-6 text-center text-teal-600">Sign Up</h2>
            <div class="mb-4">
                <label for="signupEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="signupEmail" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
            </div>
            <div class="mb-6">
                <label for="signupPassword" class="block text-sm font-medium text-gray-700 mb-1">Password (min. 6 characters)</label>
                <input type="password" id="signupPassword" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
            </div>
            <button type="submit" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150">Sign Up</button>
            <p class="mt-6 text-center text-sm">
                Already have an account? <a href="#" id="switchToLogin" class="font-medium text-teal-600 hover:text-teal-500">Login</a>
            </p>
        </form>
    </div>

    <div id="dashboardContainer" class="dashboard-container mx-auto bg-white p-8 rounded-lg shadow-xl hidden w-full">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700">My Dynamic Links</h1>
                <p class="text-gray-600">Welcome, <span id="userEmailDisplay" class="font-semibold">user@example.com</span>!</p>
            </div>
            <button id="logoutButton" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition duration-150">Logout</button>
        </div>

        <div id="createLinkContainer" class="mb-8 p-6 bg-gray-50 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Create New Dynamic Link</h2>
            <form id="createLinkForm">
                <div class="mb-4">
                    <label for="destinationUrl" class="block text-sm font-medium text-gray-700 mb-1">Destination URL (e.g., https://example.com)</label>
                    <input type="url" id="destinationUrl" name="destinationUrl" required placeholder="https://your-target-link.com" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="linkName" class="block text-sm font-medium text-gray-700 mb-1">Link Name (Optional)</label>
                    <input type="text" id="linkName" name="linkName" placeholder="My Awesome Campaign" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 transition duration-150">
                    Create Link & Get QR
                </button>
            </form>
        </div>

        <div id="linksListContainer">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Your Links</h2>
            <div id="linksList" class="space-y-4">
                <p class="text-gray-500" id="noLinksMessage">You haven't created any links yet. Use the form above to get started!</p>
            </div>
        </div>
    </div>

    <div class="message-popup"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            getDocs, 
            serverTimestamp, 
            doc, 
            deleteDoc,
            // updateDoc // For future edit functionality
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7zHDiTQqReFpPzph7M49o3560UGIl3u0", 
            authDomain: "dynamic-qr-bb507.firebaseapp.com",
            projectId: "dynamic-qr-bb507",
            storageBucket: "dynamic-qr-bb507.firebasestorage.app",
            messagingSenderId: "479705625954",
            appId: "1:479705625954:web:9bfd7b5c753dd643e2283b",
            measurementId: "G-LJGGHDVYLB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const authContainer = document.getElementById('authContainer');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const switchToSignup = document.getElementById('switchToSignup');
            const switchToLogin = document.getElementById('switchToLogin');

            const dashboardContainer = document.getElementById('dashboardContainer');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const logoutButton = document.getElementById('logoutButton');
            
            const createLinkForm = document.getElementById('createLinkForm');
            const linksListDiv = document.getElementById('linksList');
            const noLinksMessage = document.getElementById('noLinksMessage');

            let messagePopup = document.body.querySelector('.message-popup');

            function showMessage(message, type = 'success', duration = 3000) {
                if (!messagePopup) { console.error("Message popup element not found."); return; }
                messagePopup.textContent = message;
                messagePopup.className = `message-popup ${type} show`;
                setTimeout(() => { messagePopup.classList.remove('show'); }, duration);
            }
            
            // --- Short Code Generation ---
            function generateShortCode(length = 6) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }

            async function isShortCodeUnique(shortCode) {
                const linksRef = collection(db, "links");
                const q = query(linksRef, where("shortCode", "==", shortCode));
                const querySnapshot = await getDocs(q);
                return querySnapshot.empty; // True if no documents found (unique)
            }

            // --- Link Rendering ---
            function renderLinkItem(linkData) {
                if (noLinksMessage) noLinksMessage.classList.add('hidden');

                const linkItem = document.createElement('div');
                linkItem.className = 'link-item bg-white p-4 rounded-lg shadow border border-gray-200 flex flex-col md:flex-row justify-between items-center space-y-3 md:space-y-0 md:space-x-4';
                linkItem.setAttribute('data-id', linkData.id);

                const linkInfo = document.createElement('div');
                linkInfo.className = 'flex-grow';
                
                const linkNameH3 = document.createElement('h3');
                linkNameH3.className = 'font-semibold text-lg text-indigo-600 break-all';
                linkNameH3.textContent = linkData.linkName || 'Untitled Link';
                
                const originalUrlP = document.createElement('p');
                originalUrlP.className = 'text-sm text-gray-500 truncate';
                originalUrlP.innerHTML = `Original: <a href="${linkData.originalUrl}" target="_blank" class="hover:underline">${linkData.originalUrl}</a>`;
                
                const shortLinkP = document.createElement('p');
                shortLinkP.className = 'text-sm text-blue-500 font-medium';
                // Construct the short URL based on your domain. For local testing, it's relative.
                // For a live site, it would be e.g., https://yourdomain.com/r/?id=${linkData.shortCode}
                const shortUrl = `${window.location.origin}/r/?id=${linkData.shortCode}`;
                shortLinkP.innerHTML = `Short Link: <a href="${shortUrl}" target="_blank" class="hover:underline">${shortUrl}</a>`;

                linkInfo.appendChild(linkNameH3);
                linkInfo.appendChild(originalUrlP);
                linkInfo.appendChild(shortLinkP);

                const qrCodeActionsDiv = document.createElement('div');
                qrCodeActionsDiv.className = 'flex flex-col items-center space-y-2 md:items-end';

                const qrCodeContainer = document.createElement('div');
                qrCodeContainer.className = 'qr-code-container'; // For styling the QR code
                // Generate QR Code
                new QRCode(qrCodeContainer, {
                    text: shortUrl,
                    width: 100,
                    height: 100,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'mt-2 flex space-x-2';
                
                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-sm text-red-500 hover:text-red-700 hover:underline focus:outline-none';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = async () => {
                    if (confirm('Are you sure you want to delete this link?')) {
                        try {
                            await deleteDoc(doc(db, "links", linkData.id));
                            showMessage('Link deleted successfully!', 'success');
                            loadUserLinks(); // Refresh the list
                        } catch (error) {
                            console.error("Error deleting link:", error);
                            showMessage(`Error deleting link: ${error.message}`, 'error');
                        }
                    }
                };
                actionsDiv.appendChild(deleteButton);
                // (Edit button can be added here later)

                qrCodeActionsDiv.appendChild(qrCodeContainer);
                qrCodeActionsDiv.appendChild(actionsDiv);
                
                linkItem.appendChild(linkInfo);
                linkItem.appendChild(qrCodeActionsDiv);
                linksListDiv.appendChild(linkItem);
            }

            // --- Load User Links ---
            async function loadUserLinks() {
                if (!auth.currentUser) return;
                linksListDiv.innerHTML = ''; // Clear existing links
                if (noLinksMessage) noLinksMessage.classList.remove('hidden'); // Show initially

                const userId = auth.currentUser.uid;
                const linksRef = collection(db, "links");
                const q = query(linksRef, where("userId", "==", userId)); // Consider adding orderBy("createdAt", "desc") later

                try {
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty && noLinksMessage) {
                        noLinksMessage.classList.remove('hidden');
                    } else {
                        if (noLinksMessage) noLinksMessage.classList.add('hidden');
                        querySnapshot.forEach((doc) => {
                            renderLinkItem({ id: doc.id, ...doc.data() });
                        });
                    }
                } catch (error) {
                    console.error("Error loading links:", error);
                    showMessage(`Error loading links: ${error.message}`, 'error');
                    if (noLinksMessage) noLinksMessage.classList.remove('hidden'); // Show if error
                }
            }

            // --- Auth State Observer ---
            if (authContainer && dashboardContainer && userEmailDisplay) {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User signed in:", user.email);
                        authContainer.classList.add('hidden');
                        dashboardContainer.classList.remove('hidden');
                        userEmailDisplay.textContent = user.email;
                        loadUserLinks(); // Load links when user signs in
                    } else {
                        console.log("User signed out");
                        authContainer.classList.remove('hidden');
                        dashboardContainer.classList.add('hidden');
                        userEmailDisplay.textContent = '';
                        linksListDiv.innerHTML = ''; // Clear links
                        if (noLinksMessage) {
                             noLinksMessage.classList.remove('hidden');
                             noLinksMessage.textContent = 'Please log in to see your links.';
                        }
                    }
                });
            } else {
                console.error("Essential DOM elements for auth state changes are missing.");
            }

            // --- Event Listeners ---
            // Login, Signup, Logout (from Step 2 - ensure they are here)
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => { /* ... (existing login logic) ... */ 
                    e.preventDefault();
                    const email = loginForm.loginEmail.value;
                    const password = loginForm.loginPassword.value;
                    if (!email || !password) { showMessage('Please enter both email and password.', 'error'); return; }
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        showMessage('Login successful!', 'success'); loginForm.reset(); 
                    } catch (error) { showMessage(`Login failed: ${error.message}`, 'error', 5000); }
                });
            }
            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => { /* ... (existing signup logic) ... */ 
                    e.preventDefault();
                    const email = signupForm.signupEmail.value;
                    const password = signupForm.signupPassword.value;
                    if (!email || !password) { showMessage('Please enter both email and password.', 'error'); return; }
                    if (password.length < 6) { showMessage('Password should be at least 6 characters long.', 'error'); return; }
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessage('Signup successful! You are now logged in.', 'success'); signupForm.reset();
                    } catch (error) { showMessage(`Signup failed: ${error.message}`, 'error', 5000); }
                });
            }
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => { /* ... (existing logout logic) ... */ 
                    try { await signOut(auth); showMessage('Logout successful!', 'success');
                    } catch (error) { showMessage(`Logout failed: ${error.message}`, 'error'); }
                });
            }
            if (switchToSignup && loginForm && signupForm) {
                switchToSignup.addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); loginForm.reset(); });
            }
            if (switchToLogin && loginForm && signupForm) {
                switchToLogin.addEventListener('click', (e) => { e.preventDefault(); signupForm.classList.add('hidden'); loginForm.classList.remove('hidden'); signupForm.reset(); });
            }

            // Create Link Form
            if (createLinkForm) {
                createLinkForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!auth.currentUser) {
                        showMessage('You must be logged in to create links.', 'error');
                        return;
                    }

                    const destinationUrl = createLinkForm.destinationUrl.value;
                    const linkName = createLinkForm.linkName.value.trim(); // Optional

                    if (!destinationUrl) {
                        showMessage('Destination URL is required.', 'error');
                        return;
                    }
                    // Basic URL validation (can be more robust)
                    try {
                        new URL(destinationUrl);
                    } catch (_) {
                        showMessage('Invalid Destination URL format.', 'error');
                        return;
                    }


                    let newShortCode = generateShortCode();
                    let attempts = 0;
                    const maxAttempts = 10; // Prevent infinite loop in rare case of many collisions
                    while (!(await isShortCodeUnique(newShortCode)) && attempts < maxAttempts) {
                        newShortCode = generateShortCode();
                        attempts++;
                    }

                    if (attempts >= maxAttempts) {
                        showMessage('Could not generate a unique short code. Please try again.', 'error');
                        console.error("Failed to generate unique short code after multiple attempts.");
                        return;
                    }

                    try {
                        const linksCollectionRef = collection(db, "links");
                        await addDoc(linksCollectionRef, {
                            userId: auth.currentUser.uid,
                            originalUrl: destinationUrl,
                            linkName: linkName || null, // Store null if empty
                            shortCode: newShortCode,
                            createdAt: serverTimestamp(),
                            clickCount: 0 // Initialize click count
                        });
                        showMessage('Link created successfully!', 'success');
                        createLinkForm.reset();
                        loadUserLinks(); // Refresh the list
                    } catch (error) {
                        console.error("Error creating link:", error);
                        showMessage(`Error creating link: ${error.message}`, 'error');
                    }
                });
            } else {
                console.error("Create Link form not found. Check ID: createLinkForm");
            }
        }); // End of DOMContentLoaded
    </script>
</body>
</html>
